#!/bin/bash

# Ensure REPO_HOME and ENV_DEV_BUILD are set
if [ -z "$REPO_HOME" ]; then
  echo "release:: REPO_HOME is not set."
  exit 1
fi

if [ -z "$ENV_DEV_BUILD" ]; then
  echo "release:: ENV_DEV_BUILD is not set."
  exit 1
fi

# Define release directory
release_dir="$REPO_HOME/release_candidate"

# Create release directory if it doesn't exist
if [ ! -d "$release_dir" ]; then
  mkdir -p "$release_dir"
fi

# Function to copy and set permissions
install_file() {
  source_fp="$1"
  target_dp="$2"
  perms="$3"
  
  target_file="$target_dp/$(basename "$source_fp")"

  if [ ! -f "$source_fp" ]; then
    echo "install_file:: Source file '$source_fp' does not exist."
    return 1
  fi

  if ! install -m "$perms" "$source_fp" "$target_file"; then
    echo "Error: Failed to install $(basename "$source_fp") to $target_dp"
    exit 1
  else
    echo "Installed $(basename "$source_fp") to $target_dp with permissions $perms"
  fi
}
 
echo "Starting release process..."

# Paths to shell wrappers and JAR file
shell_dir="$REPO_HOME/developer/shell"
Ariadne_jar_fp="$REPO_HOME/developer/jvm/Ariadne.jar"

# Install the JAR file
install_file "$Ariadne_jar_fp" "$release_dir" "ug+r"

# Install shell wrappers
for wrapper in black blue green; do
  install_file "$shell_dir/$wrapper" "$release_dir" "ug+r+x"
done

echo "Release process completed successfully."
